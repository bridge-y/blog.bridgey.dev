---
title: "Slackで記念日を通知"
date: 2019-05-12T18:43:44+09:00
draft: false
tags: ["Slack", "Bot", "Python"]
---

Slackで記念日の通知をボットにやらせると捗るよ、っていうお話。  

どんな機能か
---

「記念日」と投稿すると、設定した記念日から何日経過したかを通知します。  
[こちら](http://blog.8arrow.org/entry/2016/01/13/183349)のブログで紹介されている機能を自分で実装しました。  

{{% img src="images/anniversary-example.png" %}}

このように、我が家のSlackボットである**ウツボットくん**が各種イベントからの経過日数をお知らせしてくれます。  

利用したもの
---

- [はてなカウンティング](https://counting.hatelabo.jp/)
- [wkhtmltoimage](https://wkhtmltopdf.org/)
- [Gyazo](https://gyazo.com/)
- [lins05/slackbot](https://github.com/lins05/slackbot)

参考にしたブログと同様に、はてなカウンティングに登録した記念日のページのスクショを撮り、Gyazoにアップロードしています。  
スクショの取得と切り抜きにはwkhtmltoimageを利用しています。  

SlackボットのライブラリはHubotではなく、Python製のslackbotを利用しています。  
反応させたい単語をデコレータに記述する点が特徴的なライブラリです。  

定期実行
---

任意のタイミングだけでなく、cronを使って毎朝投稿させています。  

毎朝の投稿は少し工夫して、以下のいずれかの条件を満たす記念日しか投稿されないようにしています。  

- 記念日と日にちが同じ
- 経過日数がキリのいい数字  
  **111**のようなゾロ目、**100**のような最上位桁以外が0の数字、**345**や**654**のような連番
- 経過日数が素数

素数判定にはミラー・ラビン素数判定法を使っています。  
コードは[こちら](http://d.hatena.ne.jp/pashango_p/20090704/1246692091)のブログのものを利用しました。  
理由は、いくつか試した中で最も高速だったからです。  

つい最近まで、経過日数が**キリのいい数字**か、**素数**か、の2つの条件での運用だったのですが、GW中にソースコードを改修した際に**日にちが同じ**という条件も加えました。  

日にちが同じ場合のメッセージは、経過日数の画像はなく、``○年目の記念日です🎉``のようなテキストだけになっています。  
テキストだけは寂しいので、そのうち画像などでリッチにしたいと考えています。  

おわりに
---

我が家で運用しているボットの機能の1つである、記念日機能を紹介しました。  
時間の経過を感じたり、素数を知れたりと割と便利な機能です。  

**1129** (いい肉) が素数であることを、この機能のおかげで知ることができました。  

{{% img src="images/anniversary-1129.png" %}}

ちなみに、設定している記念日は偶然にも偶数日ずつ離れているので、たまに素数条件での投稿が重なります。  
この現象も楽しんでいます。  

{{% img src="images/anniversary-prime.png" %}}


# 参考
- [割と本気で家庭用Slack Botを作ってみた](http://blog.8arrow.org/entry/2016/01/13/183349)
- [Pythonを使って高速素数判定をしてみる](http://d.hatena.ne.jp/pashango_p/20090704/1246692091)

